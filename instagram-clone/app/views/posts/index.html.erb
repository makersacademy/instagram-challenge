<h1>Main Feed</h1>
<%= link_to 'Log out', "/sessions/#{session[:id]}", method: :delete %>

<% if @posts %>
  <% @posts.each.with_index do |post, i| %>
    <% @user = User.find(post.user_id) %>
    <% @comments = Comment.where({ post_id: post.id }) %>

    <p><%= image_tag(post.image) %></p>
    <p><%= post.description %></p>
    <%= "posted by #{@user.first_name} #{@user.last_name} on #{post.created_at.strftime '%d %b %Y at %H:%M'}" %>
    
    <% if session[:id] == @user.id %>
      <%= link_to 'edit description', "/posts/#{post.id}/edit" %>
      <%= link_to 'delete', "/posts/#{post.id}", method: :delete %>
    <% end %>

    <%= 
      like = Like.all[0]
      "#{User.find(like.user_id).first_name} liked your post" if like
    %> 

    <% @existing_like = Like.find_by({ user_id: session[:id] }) %>
    <% if @existing_like %>
      <%= link_to 'Unlike', "/likes/#{@existing_like.id}", method: :delete %>
    <% else %>
      <%= link_to 'Like', '/likes', method: :post, post_id: post.id %>
    <% end %>

    <% @comments.each do |comment| %>
      <% @comment_user = User.find(comment.user_id) %>
      <%= @comment_user.first_name %> ~ <%= comment.body %>
      <p>Posted on <%= comment.created_at.strftime '%d %b %Y at %H:%M'%></p>

      <% if [@user.id, @comment_user.id].include? session[:id] %>
        <%= link_to 'delete comment', "/comments/#{comment.id}", method: :delete %>
      <% end %>
    <% end %>

    <%= form_for :comment, url: "/comments" do |f| %>
      Leave a comment: <%= f.text_field :body, name: "body" %><br />
      <%= hidden_field_tag :post_id, post.id %>
      <%= f.submit :Post, name: 'post' %><br />
    <% end %>

  <% end %>
<% else %>
  <p>No posts in the world yet..</p>
<% end%>
